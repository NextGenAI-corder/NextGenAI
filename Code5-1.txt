import time
import requests
import json
import os

# å„ç¨®APIã‚­ãƒ¼ã®è¨­å®šï¼ˆâ€»ã”è‡ªèº«ã®å€¤ã§ç’°å¢ƒå¤‰æ•°ãªã©ã‹ã‚‰å–å¾—ã—ã¦ä¸‹ã•ã„ï¼‰
BEARER_TOKEN = os.getenv("BEARER_TOKEN") # YOUR_TWITTER_BEARER_TOKEN
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY") # YOUR_OPENAI_API_KEY

# ğŸ“¨ è‡ªåˆ†å®›ã¦ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’å–å¾—
def get_mentions():
    headers = {"Authorization": f"Bearer {BEARER_TOKEN}"}
    url = "https://api.twitter.com/2/tweets/search/recent?query=@YourBotHandle"  # â† No.3: ãƒãƒ³ãƒ‰ãƒ«åã¯å¿…ãšæ›¸ãæ›ãˆã‚‹
    res = requests.get(url, headers=headers)
    return res.json().get("data", [])

# ğŸ’¬ ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã«è¿”ä¿¡ã‚’æŠ•ç¨¿
def send_reply(tweet_id, message):
    headers = {
        "Authorization": f"Bearer {BEARER_TOKEN}",
        "Content-Type": "application/json"
    }
    payload = {
        "text": message,
        "reply": {"in_reply_to_tweet_id": tweet_id}
    }
    url = "https://api.twitter.com/2/tweets"
    requests.post(url, headers=headers, json=payload)

# ğŸ¤– ChatGPTã¨é€£æºã—å¿œç­”ã‚’ç”Ÿæˆï¼ˆCode5-2ã®å†…å®¹ã‚’çµ±åˆï¼No.1ãƒ»No.2ï¼‰
def chat_with_gpt(user_message):
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {OPENAI_API_KEY}"
    }
    data = {
        "model": "gpt-3.5-turbo",
        "messages": [{"role": "user", "content": user_message}]
    }
    try:
        res = requests.post("https://api.openai.com/v1/chat/completions",
                            headers=headers, data=json.dumps(data))
        res.raise_for_status()
        return res.json()["choices"][0]["message"]["content"]
    except requests.exceptions.RequestException as e:
        print(f"ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
        return None

# ğŸš€ ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼šãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’å®šæœŸå–å¾— â†’ ChatGPTã§è¿”ä¿¡ â†’ æŠ•ç¨¿
def main():
    while True:
        tweets = get_mentions()
        for tweet in tweets:
            user_message = tweet["text"]
            reply = chat_with_gpt(user_message)
            send_reply(tweet["id"], reply)
            # ãƒ„ã‚¤ãƒ¼ãƒˆIDã‚’å–å¾—ï¼ˆ"id" ã¾ãŸã¯ "id_str"ï¼‰
            tweet_id = str(tweet.get("id") or tweet.get("id_str"))
            if tweet_id in replied_ids: # åŒã˜ãƒ„ã‚¤ãƒ¼ãƒˆã«é‡è¤‡è¿”ä¿¡ã—ãªã„å¯¾ç­–
                continue  # ã™ã§ã«è¿”ä¿¡æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
            user_message = tweet["text"]
            reply = chat_with_gpt(user_message)
            send_reply(tweet_id, reply)
            replied_ids.add(tweet_id)  # è¿”ä¿¡IDã‚’ç™»éŒ²
        time.sleep(30)

if __name__ == "__main__":
    main()